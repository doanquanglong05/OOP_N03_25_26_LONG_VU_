<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Đăng ký học phần (tổng hợp)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">Đăng ký học phần (EnrollmentController)</h3>

  <div class="row g-3">
    <div class="col-md-4">
      <h5>Thêm sinh viên</h5>
      <form id="addSt">
        <input class="form-control mb-2" name="id" placeholder="Mã SV" required>
        <input class="form-control mb-2" name="name" placeholder="Họ tên">
        <input class="form-control mb-2" name="gender" placeholder="Giới tính">
        <input class="form-control mb-2" name="yob" placeholder="Năm sinh" type="number">
        <input class="form-control mb-2" name="email" placeholder="Email">
        <button class="btn btn-primary">Thêm SV</button>
      </form>
    </div>

    <div class="col-md-4">
      <h5>Thêm môn học</h5>
      <form id="addCourse">
        <input class="form-control mb-2" name="id" placeholder="Mã MH" required>
        <input class="form-control mb-2" name="name" placeholder="Tên môn">
        <input class="form-control mb-2" name="credit" placeholder="Tín chỉ" type="number" value="3">
        <input class="form-control mb-2" name="desc" placeholder="Mô tả">
        <button class="btn btn-primary">Thêm MH</button>
      </form>
    </div>

    <div class="col-md-4">
      <h5>Tạo lớp học phần</h5>
      <form id="addClass">
        <input class="form-control mb-2" name="classId" placeholder="Mã lớp" required>
        <input class="form-control mb-2" name="courseId" placeholder="Mã MH" required>
        <input class="form-control mb-2" name="teacher" placeholder="Giảng viên">
        <input class="form-control mb-2" name="schedule" placeholder="Lịch học">
        <input class="form-control mb-2" name="max" placeholder="Max" type="number" value="50">
        <button class="btn btn-primary">Tạo lớp</button>
      </form>
    </div>
  </div>

  <hr class="my-4">

  <div class="row g-3">
    <div class="col-md-6">
      <h5>Gán SV vào lớp</h5>
      <form id="assign">
        <input class="form-control mb-2" name="studentId" placeholder="Mã SV" required>
        <input class="form-control mb-2" name="classId" placeholder="Mã lớp" required>
        <button class="btn btn-success">Gán</button>
      </form>
    </div>
    <div class="col-md-6">
      <h5>Báo cáo lớp</h5>
      <button class="btn btn-outline-primary mb-2" onclick="loadReport()">Tải báo cáo</button>
      <ul id="report" class="list-group"></ul>
    </div>
  </div>

  <div class="text-end mt-3">
    <a href="/" class="btn btn-outline-secondary">Trang chủ</a>
  </div>
</div>

<script>
const root = '/api/enroll';

function post(path, body) {
  return fetch(root + path, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  }).then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error(t)}); });
}

document.getElementById('addSt').addEventListener('submit', e=>{
  e.preventDefault();
  const o = Object.fromEntries(new FormData(e.target).entries());
  o.yob = Number(o.yob||0);
  post('/students', o).then(()=>e.target.reset()).catch(err=>alert(err.message));
});

document.getElementById('addCourse').addEventListener('submit', e=>{
  e.preventDefault();
  const o = Object.fromEntries(new FormData(e.target).entries());
  o.credit = Number(o.credit||0);
  post('/courses', o).then(()=>e.target.reset()).catch(err=>alert(err.message));
});

document.getElementById('addClass').addEventListener('submit', e=>{
  e.preventDefault();
  const o = Object.fromEntries(new FormData(e.target).entries());
  o.max = Number(o.max||50);
  post('/classes', o).then(()=>e.target.reset()).catch(err=>alert(err.message));
});

document.getElementById('assign').addEventListener('submit', e=>{
  e.preventDefault();
  const f = new FormData(e.target);
  const q = `?studentId=${encodeURIComponent(f.get('studentId'))}&classId=${encodeURIComponent(f.get('classId'))}`;
  fetch(root + '/assign' + q, {method:'POST'})
    .then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error(t)}); })
    .then(()=>e.target.reset())
    .catch(err=>alert(err.message));
});

function loadReport(){
  fetch(root+'/report').then(r=>r.json()).then(list=>{
    document.getElementById('report').innerHTML = list.map(x=>`<li class="list-group-item">${x}</li>`).join('');
  });
}
</script>
</body>
</html>
