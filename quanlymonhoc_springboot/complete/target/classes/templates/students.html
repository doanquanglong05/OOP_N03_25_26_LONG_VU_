<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý Sinh viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Flatpickr (datepicker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">Sinh viên</h3>

  <!-- Form thêm -->
  <form id="addForm" class="row g-2 mb-3">
    <div class="col-md-2">
      <input class="form-control" placeholder="Mã SV" name="id" required>
    </div>
    <div class="col-md-3">
      <input class="form-control" placeholder="Họ tên" name="name" required>
    </div>
    <div class="col-md-2">
      <input class="form-control" placeholder="Giới tính" name="gender">
    </div>
    <div class="col-md-2">
      <!-- Dùng flatpickr: hiển thị dd/MM/yyyy, submit yyyy-MM-dd -->
      <input class="form-control" id="dob" name="dateOfBirth" required>
    </div>
    <div class="col-md-3">
      <input class="form-control" placeholder="Email" name="email">
    </div>
    <div class="col-12 text-end">
      <button class="btn btn-primary">Thêm sinh viên</button>
      <a href="/" class="btn btn-outline-secondary">Trang chủ</a>
    </div>
  </form>

  <!-- Bảng -->
  <table class="table table-bordered bg-white" id="tbl">
    <thead>
      <tr>
        <th>Mã SV</th>
        <th>Họ tên</th>
        <th>Giới tính</th>
        <th>Ngày sinh</th>
        <th>Email</th>
        <th style="width:160px">Thao tác</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal Sửa Sinh viên -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="editStudentForm">
      <div class="modal-header">
        <h5 class="modal-title">Sửa sinh viên</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body row g-2">
        <!-- giữ oldId ẩn để gọi API theo ID cũ -->
        <input type="hidden" id="es_old_id">

        <div class="col-md-4">
          <label class="form-label">Mã SV</label>
          <input class="form-control" name="id" id="es_id" required>
        </div>
        <div class="col-md-8">
          <label class="form-label">Họ tên</label>
          <input class="form-control" name="name" id="es_name" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Giới tính</label>
          <input class="form-control" name="gender" id="es_gender">
        </div>
        <div class="col-md-4">
          <label class="form-label">Ngày sinh</label>
          <!-- flatpickr cho form sửa -->
          <input class="form-control" name="dateOfBirth" id="es_dob" required>
        </div>
        <div class="col-md-8">
          <label class="form-label">Email</label>
          <input class="form-control" name="email" id="es_email">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary">Lưu</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = '/api/students';

// yyyy-MM-dd -> dd/MM/yyyy (dùng khi render bảng)
function formatDate(iso) {
  if (!iso) return '';
  const [y, m, d] = iso.split('-');
  if (!d) return iso;
  return `${d}/${m}/${y}`;
}

function load() {
  fetch(API).then(r=>r.json()).then(data=>{
    document.querySelector('#tbl tbody').innerHTML = data.map(s=>`
      <tr>
        <td>${s.id}</td>
        <td>${s.name||''}</td>
        <td>${s.gender||''}</td>
        <td>${formatDate(s.dateOfBirth)}</td>
        <td>${s.email||''}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-warning me-1" data-id="${s.id}" onclick="openEditById(this)">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="delStudent('${s.id}')">Xóa</button>
        </td>
      </tr>`).join('');
  });
}

function delStudent(id){
  fetch(API+'/'+encodeURIComponent(id), { method:'DELETE' })
    .then(()=>load());
}

// ----- Thêm mới -----
document.getElementById('addForm').addEventListener('submit', e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const body = Object.fromEntries(fd.entries()); // dateOfBirth = yyyy-MM-dd (flatpickr đã set)
  body.id = (body.id || '').trim();

  fetch(API, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    })
    .then(r=>{ if(!r.ok) return r.text().then(t=>{ throw new Error(t) }); })
    .then(()=>{ e.target.reset(); dobPicker.clear(); load(); })
    .catch(err=>alert(err.message || 'Lỗi'));
});

// ----- Sửa -----
let editStudentModal;
let dobPicker;     // picker ở form thêm
let esDobPicker;   // picker ở modal sửa

document.addEventListener('DOMContentLoaded', ()=>{
  editStudentModal = new bootstrap.Modal('#editStudentModal');

  // Khởi tạo flatpickr: submit "Y-m-d", hiển thị "d/m/Y"
  dobPicker = flatpickr("#dob", {
    dateFormat: "Y-m-d",
    altInput: true,
    altFormat: "d/m/Y",
    locale: "vn"
  });

  esDobPicker = flatpickr("#es_dob", {
    dateFormat: "Y-m-d",
    altInput: true,
    altFormat: "d/m/Y",
    locale: "vn"
  });

  document.getElementById('editStudentForm').addEventListener('submit', submitEditStudent);
});

// mở modal bằng cách fetch theo id
function openEditById(btn){
  const id = btn.getAttribute('data-id');
  fetch(`${API}/${encodeURIComponent(id)}`)
    .then(r => {
      if(!r.ok) throw new Error('Không tìm thấy sinh viên');
      return r.json();
    })
    .then(s => openEditStudent(s))
    .catch(err => alert(err.message || 'Lỗi'));
}

function openEditStudent(s) {
  document.getElementById('es_old_id').value = s.id || '';   // ID cũ
  document.getElementById('es_id').value     = s.id || '';   // ID mới (có thể đổi)
  document.getElementById('es_name').value   = s.name || '';
  document.getElementById('es_gender').value = s.gender || '';
  esDobPicker.setDate(s.dateOfBirth || null, true, "Y-m-d"); // set yyyy-MM-dd
  document.getElementById('es_email').value  = s.email || '';
  editStudentModal.show();
}

function submitEditStudent(e){
  e.preventDefault();
  const oldId = document.getElementById('es_old_id').value;      // gọi API theo ID cũ
  const body = {
    id:          document.getElementById('es_id').value.trim(),  // ID mới
    name:        document.getElementById('es_name').value,
    gender:      document.getElementById('es_gender').value,
    dateOfBirth: document.getElementById('es_dob').value,        // yyyy-MM-dd (từ flatpickr)
    email:       document.getElementById('es_email').value
  };
  if (!body.id) { alert('Mã SV không được để trống'); return; }

  fetch(`${API}/${encodeURIComponent(oldId)}`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  })
  .then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error(t)}); })
  .then(()=>{ editStudentModal.hide(); load(); })
  .catch(err=>alert(err.message||'Lỗi cập nhật'));
}

load();
</script>

<!-- Bootstrap JS (bundle) + Flatpickr scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
</body>
</html>
