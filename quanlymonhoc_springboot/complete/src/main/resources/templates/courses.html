<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Môn học</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">Môn học</h3>

  <!-- Form thêm -->
  <form id="addForm" class="row g-2 mb-3">
    <div class="col-md-2"><input class="form-control" name="courseId" placeholder="Mã MH" required></div>
    <div class="col-md-4"><input class="form-control" name="courseName" placeholder="Tên môn" required></div>
    <div class="col-md-2"><input class="form-control" name="credit" type="number" placeholder="Tín chỉ" value="3" min="0"></div>
    <div class="col-md-4"><input class="form-control" name="description" placeholder="Mô tả"></div>
    <div class="col-12 text-end">
      <button class="btn btn-primary">Thêm môn</button>
      <a href="/" class="btn btn-outline-secondary">Trang chủ</a>
    </div>
  </form>

  <!-- Bảng -->
  <table class="table table-bordered bg-white" id="tbl">
    <thead>
      <tr>
        <th>Mã MH</th>
        <th>Tên môn</th>
        <th>Tín chỉ</th>
        <th>Mô tả</th>
        <th style="width:160px">Thao tác</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal Sửa Môn học -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="editCourseForm">
      <div class="modal-header">
        <h5 class="modal-title">Sửa môn học</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body row g-2">
        <!-- giữ id cũ để gọi API -->
        <input type="hidden" id="ec_old_id">

        <div class="col-md-4">
          <label class="form-label">Mã MH</label>
          <input class="form-control" id="ec_id" required>
        </div>
        <div class="col-md-8">
          <label class="form-label">Tên môn</label>
          <input class="form-control" id="ec_name" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Tín chỉ</label>
          <input type="number" class="form-control" id="ec_credit" min="0" required>
        </div>
        <div class="col-md-12">
          <label class="form-label">Mô tả</label>
          <input class="form-control" id="ec_desc">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary">Lưu</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = '/api/courses';

// Tải danh sách
function load(){
  fetch(API).then(r=>r.json()).then(list=>{
    document.querySelector('#tbl tbody').innerHTML = list.map(c=>`
      <tr>
        <td>${c.courseId}</td>
        <td>${c.courseName||''}</td>
        <td>${c.credit||0}</td>
        <td>${c.description||''}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-warning me-1" data-id="${c.courseId}" onclick="openEditById(this)">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="delCourse('${c.courseId}')">Xóa</button>
        </td>
      </tr>`).join('');
  });
}

// Xóa
function delCourse(id){
  fetch(`${API}/${encodeURIComponent(id)}`, {method:'DELETE'})
    .then(()=>load());
}

// Thêm mới
document.getElementById('addForm').addEventListener('submit', e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const body = Object.fromEntries(fd.entries());
  body.courseId   = (body.courseId||'').trim();
  body.courseName = (body.courseName||'').trim();
  body.credit     = Number(body.credit||0);
  fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  })
  .then(r=>{ if(!r.ok) return r.text().then(t=>{ throw new Error(t) }); })
  .then(()=>{ e.target.reset(); load(); })
  .catch(err=>alert(err.message||'Lỗi'));
});

// ----------- Sửa -----------
let editCourseModal;
document.addEventListener('DOMContentLoaded', ()=>{
  editCourseModal = new bootstrap.Modal('#editCourseModal');
  document.getElementById('editCourseForm').addEventListener('submit', submitEditCourse);
});

// mở modal bằng cách fetch theo id (đảm bảo dữ liệu mới nhất)
function openEditById(btn){
  const id = btn.getAttribute('data-id');
  fetch(`${API}/${encodeURIComponent(id)}`)
    .then(r=>{ if(!r.ok) throw new Error('Không tìm thấy môn học'); return r.json(); })
    .then(c => openEditCourse(c))
    .catch(err => alert(err.message||'Lỗi'));
}

function openEditCourse(c){
  document.getElementById('ec_old_id').value = c.courseId || '';
  document.getElementById('ec_id').value     = c.courseId || '';
  document.getElementById('ec_name').value   = c.courseName || '';
  document.getElementById('ec_credit').value = c.credit ?? 0;
  document.getElementById('ec_desc').value   = c.description || '';
  editCourseModal.show();
}

function submitEditCourse(e){
  e.preventDefault();
  const oldId = document.getElementById('ec_old_id').value;
  const body = {
    courseId:   document.getElementById('ec_id').value.trim(),   // ID mới (nếu đổi)
    courseName: document.getElementById('ec_name').value.trim(),
    credit:     Number(document.getElementById('ec_credit').value||0),
    description:document.getElementById('ec_desc').value
  };
  if (!body.courseId) { alert('Mã MH không được trống'); return; }

  fetch(`${API}/${encodeURIComponent(oldId)}`, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  })
  .then(r=>{ if(!r.ok) return r.text().then(t=>{ throw new Error(t) }); })
  .then(()=>{ editCourseModal.hide(); load(); })
  .catch(err=>alert(err.message||'Lỗi cập nhật'));
}

load();
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
