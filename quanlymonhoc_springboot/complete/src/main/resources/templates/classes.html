<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Lớp học phần</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">Lớp học phần</h3>

  <!-- Tạo lớp -->
  <form id="createClass" class="row g-2 mb-3">
    <div class="col-md-2"><input class="form-control" name="classId" placeholder="Mã lớp" required></div>
    <div class="col-md-2"><input class="form-control" name="courseId" placeholder="Mã môn (C001...)" required></div>
    <div class="col-md-2"><input class="form-control" name="teacherName" placeholder="Giảng viên"></div>
    <div class="col-md-3"><input class="form-control" name="schedule" placeholder="Lịch học (T2-3,T5-3)"></div>
    <div class="col-md-1"><input class="form-control" name="maxStudents" type="number" placeholder="Max" value="50"></div>
    <div class="col-md-2 text-end"><button class="btn btn-primary w-100">Tạo lớp</button></div>
    <div class="col-12 text-end mt-1"><a href="/" class="btn btn-outline-secondary">Trang chủ</a></div>
  </form>

  <!-- Gán SV -->
  <form id="assign" class="row g-2 mb-3">
    <div class="col-md-3"><input class="form-control" name="classId" placeholder="Mã lớp cần gán" required></div>
    <div class="col-md-3"><input class="form-control" name="studentId" placeholder="Mã SV" required></div>
    <div class="col-md-2"><button class="btn btn-success w-100">Gán SV vào lớp</button></div>
  </form>

  <!-- Danh sách lớp -->
  <table class="table table-bordered bg-white" id="tbl">
    <thead>
      <tr>
        <th>Mã lớp</th>
        <th>Môn học</th>
        <th>Giảng viên</th>
        <th>Lịch học</th>
        <th>Max</th>
        <th>Số SV</th>
        <th style="width:160px">Thao tác</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal Sửa Lớp học phần -->
<div class="modal fade" id="editClassModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="editClassForm">
      <div class="modal-header">
        <h5 class="modal-title">Sửa lớp học phần</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body row g-2">
        <!-- giữ classId để gọi API -->
        <input type="hidden" id="cl_old_id">

        <div class="col-md-6">
          <label class="form-label">Mã lớp</label>
          <!-- id cũ để gọi API -->
<input type="hidden" id="cl_old_id">
<label class="form-label">Mã lớp (có thể đổi)</label>
<input class="form-control" id="cl_id" required>

        </div>

        <div class="col-md-6">
          <label class="form-label">Mã môn (tùy chọn, để trống nếu không đổi)</label>
          <input class="form-control" id="cl_courseId" placeholder="C001...">
        </div>

        <div class="col-md-6">
          <label class="form-label">Giảng viên</label>
          <input class="form-control" id="cl_teacher">
        </div>

        <div class="col-md-6">
          <label class="form-label">Lịch học</label>
          <input class="form-control" id="cl_schedule" placeholder="T2-3,T5-3">
        </div>

        <div class="col-md-4">
          <label class="form-label">Sĩ số tối đa</label>
          <input type="number" class="form-control" id="cl_max" min="1" placeholder="50">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary">Lưu</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = '/api/classes';

function load(){
  fetch(API).then(r=>r.json()).then(list=>{
    document.querySelector('#tbl tbody').innerHTML = list.map(c=>`
      <tr>
        <td>${c.classId}</td>
        <td>${c.course ? ( (c.course.courseName||c.course.name||'') + ' (' + (c.course.courseId||'') + ')' ) : ''}</td>
        <td>${c.teacherName||''}</td>
        <td>${c.schedule||''}</td>
        <td>${c.maxStudents||0}</td>
        <td>${(c.students||[]).length}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-warning me-1" data-id="${c.classId}" onclick="openEditById(this)">Sửa</button>
          <button class="btn btn-sm btn-danger" onclick="deleteClass('${c.classId}')">Xóa</button>
        </td>
      </tr>`).join('');
  });
}

// Tạo lớp
document.getElementById('createClass').addEventListener('submit', e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const body = Object.fromEntries(fd.entries());
  body.maxStudents = Number(body.maxStudents||50);
  fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  })
  .then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error(t)}); })
  .then(()=>{ e.target.reset(); load(); })
  .catch(err=>alert(err.message||'Lỗi tạo lớp'));
});

// Gán SV
document.getElementById('assign').addEventListener('submit', e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const classId = fd.get('classId');
  const studentId = fd.get('studentId');
  fetch(`${API}/${encodeURIComponent(classId)}/assign?studentId=${encodeURIComponent(studentId)}`, {method:'POST'})
    .then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error(t)}); })
    .then(()=>{ e.target.reset(); load(); })
    .catch(err=>alert(err.message||'Không gán được (mã lớp/mã SV sai hoặc lớp đầy/trùng SV)'));
});

// ----------- Sửa -----------
let editClassModal;
document.addEventListener('DOMContentLoaded', ()=>{
  editClassModal = new bootstrap.Modal('#editClassModal');
  document.getElementById('editClassForm').addEventListener('submit', submitEditClass);
});

// mở modal theo id (đảm bảo dữ liệu mới)
function openEditById(btn){
  const id = btn.getAttribute('data-id');
  fetch(`${API}/${encodeURIComponent(id)}`)
    .then(r=>{ if(!r.ok) throw new Error('Không tìm thấy lớp'); return r.json(); })
    .then(c=>openEditClass(c))
    .catch(err=>alert(err.message||'Lỗi'));
}

function openEditClass(c){
  document.getElementById('cl_old_id').value = c.classId || '';
  document.getElementById('cl_id').value     = c.classId || '';
  document.getElementById('cl_courseId').value = (c.course && (c.course.courseId||'')) || '';
  document.getElementById('cl_teacher').value  = c.teacherName || '';
  document.getElementById('cl_schedule').value = c.schedule || '';
  document.getElementById('cl_max').value      = c.maxStudents ?? '';
  editClassModal.show();
}

function submitEditClass(e){
  e.preventDefault();
  const oldId   = document.getElementById('cl_old_id').value;      // id cũ dùng trên URL
  const newId   = document.getElementById('cl_id').value.trim();   // id mới trong form
  const courseId= document.getElementById('cl_courseId').value.trim();

  if (!newId) { alert('Mã lớp không được trống'); return; }

  const body = {
    classId:     newId,                       // <-- gửi classId mới
    courseId:    courseId || null,
    teacherName: document.getElementById('cl_teacher').value || null,
    schedule:    document.getElementById('cl_schedule').value || null,
    maxStudents: Number(document.getElementById('cl_max').value || 0) || null
  };

  fetch(`${API}/${encodeURIComponent(oldId)}`, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  })
  .then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error(t)}); })
  .then(()=>{ editClassModal.hide(); load(); })
  .catch(err=>alert(err.message||'Lỗi cập nhật lớp'));
}


// Xóa lớp
function deleteClass(id){
  if (!confirm('Bạn có chắc muốn xóa lớp ' + id + ' ?')) return;
  fetch(`${API}/${encodeURIComponent(id)}`, { method:'DELETE' })
    .then(r=>{
      if (r.status === 204) return;
      if(!r.ok) return r.text().then(t=>{ throw new Error(t) });
    })
    .then(()=>load())
    .catch(err=>alert(err.message||'Xóa không thành công'));
}

load();
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
